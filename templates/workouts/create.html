{# templates/workouts/plan_form.html #}
{% extends "form_base.html" %}
{% load widget_tweaks %}
{% block form_title %}Create Workout Plan{% endblock %}
{% block back_url %}{% url 'workouts:list' %}{% endblock %}

{% block form_fields %}
<div class="space-y-6">
  <!-- Tabs -->
  <div class="flex border-b border-gray-200 min-w-max">
    <button
      id="tab-plan"
      type="button"
      class="px-4 py-2 -mb-px border-b-2 border-primary-600 text-primary-600 font-medium"
    >
      Plan Details
    </button>
    <button
      id="tab-schedule"
      type="button"
      class="px-4 py-2 text-gray-600 hover:text-gray-800"
    >
      Schedule Settings
    </button>
  </div>

  <!-- Plan Details Pane -->
  <div id="pane-plan" class="mt-4">
    {% for field in plan_form %}
      {% if field.name != "workout_structure" %}
      <div class="flex flex-col mb-4">
        <label class="text-sm font-medium text-gray-700 mb-1">
          {{ field.label }}
        </label>
        {{ field|add_class:"px-4 py-2 border border-primary-300 rounded-xl focus:ring-2 focus:ring-primary-400 transition shadow-sm" }}
        {% if field.help_text %}
          <p class="text-xs text-gray-500 mt-1">{{ field.help_text }}</p>
        {% endif %}
        {% for err in field.errors %}
          <p class="text-xs text-warning-700 mt-1">{{ err }}</p>
        {% endfor %}
      </div>
      {% endif %}
    {% endfor %}

    {# Workout Builder #}
    <div
      id="workout-builder"
      class="space-y-6"
      data-workout="{{ plan_form.instance.workout_structure|escapejs }}"
    >
      <div id="days-container" class="space-y-4"></div>
      <button
        type="button"
        id="add-day-btn"
        class="bg-gradient-to-r from-primary-600 to-primary-400 text-white px-4 py-2 rounded-xl font-semibold shadow hover:scale-105 transition"
      >
        + Add Day
      </button>
    </div>

    <input
      type="hidden"
      name="workout_structure"
      id="id_workout_structure"
      value="{{ plan_form.instance.workout_structure|escapejs }}"
    >

    <button
      type="button"
      id="generate-ai-btn"
      class="bg-blue-500 text-white px-4 py-2 rounded-xl shadow hover:scale-105 transition mt-3"
    >
      Generate AI Workout Plan
    </button>
    <div id="ai-preview" class="mt-4 p-4 bg-gray-100 rounded-xl shadow-inner"></div>
  </div>

  <!-- Schedule Settings Pane -->
  <div id="pane-schedule" class="mt-4 hidden">
    {% for field in sched_form %}
    <div class="flex flex-col mb-4">
      <label class="text-sm font-medium text-gray-700 mb-1">
        {{ field.label }}
      </label>
      {{ field|add_class:"px-4 py-2 border border-primary-300 rounded-xl focus:ring-2 focus:ring-primary-400 transition shadow-sm" }}
      {% if field.help_text %}
        <p class="text-xs text-gray-500 mt-1">{{ field.help_text }}</p>
      {% endif %}
      {% for err in field.errors %}
        <p class="text-xs text-warning-700 mt-1">{{ err }}</p>
      {% endfor %}
    </div>
    {% endfor %}
  </div>

  <div id="days-hint" class="rounded-xl border border-warning-200 bg-warning-50 text-warning-800 px-4 py-3 text-sm">
  Please select a client to configure workout days.
</div>

<div id="preferred-days-panel" class="hidden rounded-xl border border-primary-200 bg-white p-4 mt-3">
  <div class="flex items-center justify-between">
    <h3 class="text-sm font-semibold text-gray-800">Set preferred workout days</h3>
    <span class="text-xs text-gray-500">Choose 1â€“7 days</span>
  </div>
  <div class="mt-3 grid grid-cols-2 sm:grid-cols-4 gap-2">
    {% for d in days %}
      <label class="inline-flex items-center gap-2 rounded-lg border px-3 py-2 cursor-pointer hover:bg-primary-50">
        <input type="checkbox" class="pref-day-checkbox" value="{{ d }}">
        <span class="text-sm text-gray-800">{{ d }}</span>
      </label>
    {% endfor %}
  </div>
  <div class="mt-4 flex items-center gap-2">
    <button id="save-preferred-days" type="button" class="px-3 py-2 rounded-lg bg-secondary-600 text-white text-sm font-semibold hover:bg-secondary-700">
      Save preferred days
    </button>
    <span id="pref-days-feedback" class="text-xs text-gray-500"></span>
  </div>
</div>
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

</div>
{% endblock %}

{% block submit_text %}Save Workout{% endblock %}

{% block extra_js %}
<script>
  // Tab switching
  const btnPlan = document.getElementById("tab-plan");
  const btnSched = document.getElementById("tab-schedule");
  const panePlan = document.getElementById("pane-plan");
  const paneSched = document.getElementById("pane-schedule");

  btnPlan.addEventListener("click", () => {
    panePlan.classList.remove("hidden");
    paneSched.classList.add("hidden");
    btnPlan.classList.add("border-primary-600","text-primary-600");
    btnSched.classList.remove("border-primary-600","text-primary-600");
  });

  btnSched.addEventListener("click", () => {
    paneSched.classList.remove("hidden");
    panePlan.classList.add("hidden");
    btnSched.classList.add("border-primary-600","text-primary-600");
    btnPlan.classList.remove("border-primary-600","text-primary-600");
  });

  // Auto generate the workout days pased on the client preferred days

  document.addEventListener("DOMContentLoaded", function () {
  const daysContainer = document.getElementById("days-container");
  const addDayBtn = document.getElementById("add-day-btn");
  const workoutInput = document.getElementById("id_workout_structure");
  const workoutBuilder = document.getElementById("workout-builder");
  const clientSelect = document.querySelector('select[name="client"]');
  const workoutDataTag = document.getElementById("workoutData");
  const daysHint = document.getElementById("days-hint");
  const prefPanel = document.getElementById("preferred-days-panel");
  const savePrefBtn = document.getElementById("save-preferred-days");
  const prefFeedback = document.getElementById("pref-days-feedback");

  // Initial state: show builder UI, but hint + disable addDay until client selected
  addDayBtn.disabled = true;
  addDayBtn.classList.add("opacity-50", "cursor-not-allowed");
  daysHint.classList.remove("hidden");
  prefPanel.classList.add("hidden");

function updateWorkoutJSON() {
  const workoutData = [];
  const dayBlocks = daysContainer.querySelectorAll(".day-block");

  dayBlocks.forEach(dayBlock => {
    const dayNameEl = dayBlock.querySelector(".day-name");
    const dayName = (dayNameEl && dayNameEl.value || "").trim();
    if (!dayName) return; // skip nameless day

    const exercises = [];
    dayBlock.querySelectorAll(".exercise-block").forEach(exBlock => {
      const nameEl = exBlock.querySelector(".exercise-name");
      const setsEl = exBlock.querySelector(".exercise-sets");
      const repsEl = exBlock.querySelector(".exercise-reps");
      const idEl   = exBlock.querySelector(".exercise-id");

      const name = (nameEl && nameEl.value || "").trim();
      const sets = setsEl && setsEl.value !== "" ? parseInt(setsEl.value, 10) : null;
      const reps = repsEl && repsEl.value !== "" ? parseInt(repsEl.value, 10) : null;
      const idRaw = idEl && idEl.value ? idEl.value.trim() : null;
      const id = idRaw ? (isNaN(parseInt(idRaw, 10)) ? idRaw : parseInt(idRaw,10)) : null;

      // include the exercise only when it has a name
      if (name) {
        exercises.push({
          name,
          id,       // null or number (exercise global id)
          sets: Number.isFinite(sets) ? sets : null,
          reps: Number.isFinite(reps) ? reps : null
        });
      }
    });

    workoutData.push({ day: dayName, exercises });
  });

  // write into the hidden form input that gets posted
  workoutInput.value = JSON.stringify(workoutData);
  return workoutData;
}
  //   const workoutData = [];
  //   daysContainer.querySelectorAll(".day-block").forEach(dayBlock => {
  //     const dayName = dayBlock.querySelector(".day-name").value;
  //     const exercises = [];
  //     dayBlock.querySelectorAll(".exercise-block").forEach(exBlock => {
  //       const name = exBlock.querySelector(".exercise-name").value;
  //       const sets = exBlock.querySelector(".exercise-sets").value;
  //       const reps = exBlock.querySelector(".exercise-reps").value;
  //       if (name) exercises.push({ name, sets: parseInt(sets), reps: parseInt(reps) });
  //     });
  //     if (dayName) workoutData.push({ day: dayName, exercises });
  //   });
  //   workoutInput.value = JSON.stringify(workoutData);
  // }

// helper used earlier in your script (keep if you already have similar)
function escapeAttr(s) {
  if (s == null) return '';
  return String(s).replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

/**
 * addExercise(dayBlock, ex)
 * ex: { name: "", sets: "", reps: "", id: null }
 */
function addExercise(dayBlock, ex = { name: "", sets: "", reps: "", id: null }) {
  const exerciseBlock = document.createElement("div");
  exerciseBlock.className = `
    exercise-block
    grid grid-cols-1 sm:grid-cols-[2fr,1fr,1fr,auto]
    items-center gap-4
    bg-white rounded-lg shadow p-3
  `.trim();

  // safe values
  const nameVal = escapeAttr(ex.name || "");
  const setsVal = escapeAttr(ex.sets ?? "");
  const repsVal = escapeAttr(ex.reps ?? "");
  const idVal   = escapeAttr(ex.id ?? "");

  exerciseBlock.innerHTML = `
    <div class="relative col-span-1">
      <input
        type="text"
        placeholder="Exercise name"
        class="exercise-name w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-400 transition"
        value="${nameVal}"
        required
        autocomplete="off"
      />
      <input type="hidden" class="exercise-id" value="${idVal}" />
      <div class="autocomplete-dropdown hidden absolute z-50 mt-1 w-full bg-white shadow-md rounded" aria-hidden="true"></div>
    </div>

    <input
      type="number"
      placeholder="Sets"
      class="exercise-sets w-full sm:w-20 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-400 transition"
      min="1"
      value="${setsVal}"
      required
    />
    <input
      type="number"
      placeholder="Reps"
      class="exercise-reps w-full sm:w-20 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-400 transition"
      min="1"
      value="${repsVal}"
      required
    />
    <button
      type="button"
      class="remove-exercise flex items-center justify-center text-red-500 hover:text-red-700 focus:outline-none"
      aria-label="Remove exercise"
    >
      <i class="fas fa-times-circle text-lg"></i>
    </button>
  `;

  // attach events
  const nameInput = exerciseBlock.querySelector(".exercise-name");
  const hiddenId  = exerciseBlock.querySelector(".exercise-id");
  const setsInput = exerciseBlock.querySelector(".exercise-sets");
  const repsInput = exerciseBlock.querySelector(".exercise-reps");
  const removeBtn = exerciseBlock.querySelector(".remove-exercise");
  const dropdown  = exerciseBlock.querySelector(".autocomplete-dropdown");

  // When user types new text, clear any previously selected exercise-id
  nameInput.addEventListener("input", () => {
    if (hiddenId.value) hiddenId.value = "";
    updateWorkoutJSON();
  });

  // keep JSON in sync when sets/reps change
  [setsInput, repsInput].forEach(i => i.addEventListener("input", updateWorkoutJSON));

  // remove exercise
  removeBtn.addEventListener("click", () => {
    exerciseBlock.remove();
    updateWorkoutJSON();
  });

  // append to container
  const container = dayBlock.querySelector(".exercises-container");
  container.appendChild(exerciseBlock);

  // If you have autocomplete code that attaches on focus/creation,
  // new input will be picked up. If not, you can call your attach function here
  // (If you implemented the autocomplete from my previous reply it's delegated on focusin).
  // e.g. if you exposed a global attachAutocomplete: window.attachAutocomplete?.(nameInput);

  // Update JSON after adding
  updateWorkoutJSON();

  // return for caller if needed
  return exerciseBlock;
}

/**
 * updateWorkoutJSON()
 * Build workout JSON including exercise.id when present
 */
function updateWorkoutJSON() {
  const workoutData = [];
  const dayBlocks = daysContainer.querySelectorAll(".day-block");

  dayBlocks.forEach(dayBlock => {
    const dayNameEl = dayBlock.querySelector(".day-name");
    const dayName = (dayNameEl && dayNameEl.value || "").trim();
    if (!dayName) return; // skip nameless day

    const exercises = [];
    dayBlock.querySelectorAll(".exercise-block").forEach(exBlock => {
      const nameEl = exBlock.querySelector(".exercise-name");
      const setsEl = exBlock.querySelector(".exercise-sets");
      const repsEl = exBlock.querySelector(".exercise-reps");
      const idEl   = exBlock.querySelector(".exercise-id");

      const name = (nameEl && nameEl.value || "").trim();
      const sets = setsEl && setsEl.value !== "" ? parseInt(setsEl.value, 10) : null;
      const reps = repsEl && repsEl.value !== "" ? parseInt(repsEl.value, 10) : null;
      const idRaw = idEl && idEl.value ? idEl.value.trim() : null;
      const id = idRaw ? (isNaN(parseInt(idRaw, 10)) ? idRaw : parseInt(idRaw,10)) : null;

      // include the exercise only when it has a name
      if (name) {
        exercises.push({
          name,
          id,       // null or number (exercise global id)
          sets: Number.isFinite(sets) ? sets : null,
          reps: Number.isFinite(reps) ? reps : null
        });
      }
    });

    workoutData.push({ day: dayName, exercises });
  });

  // write into the hidden form input that gets posted
  workoutInput.value = JSON.stringify(workoutData);
  return workoutData;
}


function addDay(dayName = "", exercises = [], locked = false) {
  const dayBlock = document.createElement("div");
  dayBlock.className = `
    day-block
    bg-primary-50 border border-primary-200
    rounded-2xl shadow-sm
    p-4 md:p-6 mb-6
  `.trim();

  dayBlock.innerHTML = `
    <div class="day-header flex flex-col sm:flex-row sm:items-center justify-between gap-4">
      <div class="flex items-center gap-3 w-full sm:w-auto">
        <input
          type="text"
          placeholder="Day (e.g. Monday)"
          class="day-name flex-1 border border-gray-300 rounded-lg px-3 py-2 text-base font-semibold focus:ring-2 focus:ring-primary-400 transition bg-white"
          value="${dayName.replace(/"/g, '&quot;')}"
          ${locked ? "readonly" : ""}
          required
        />
        ${
          locked
            ? `<span
                 class="hidden sm:inline-block ml-2 px-2 py-1 text-xs text-gray-600
                        bg-primary-100 border border-primary-200 rounded-lg"
               >
                 Preferred day
               </span>`
            : ""
        }
      </div>
      ${
        !locked
          ? `<button
               type="button"
               class="remove-day-btn flex items-center gap-1 text-red-500 hover:text-red-700 focus:outline-none"
               aria-label="Remove day"
             >
               <i class="fas fa-trash-alt"></i>
               <span class="sr-only">Remove Day</span>
             </button>`
          : ""
      }
    </div>

    <div class="exercises-container space-y-3 mt-4"></div>

    <button
      type="button"
      class="add-exercise-btn inline-flex items-center justify-center
             w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white
             px-4 py-2 rounded-xl font-semibold shadow transition
             focus:outline-none focus:ring-2 focus:ring-green-300"
    >
      <i class="fas fa-plus mr-2"></i>Add Exercise
    </button>
  `;

  // hook up events
  dayBlock.querySelector(".add-exercise-btn")
    .addEventListener("click", () => {
      addExercise(dayBlock);
      updateWorkoutJSON();
    });

  const removeBtn = dayBlock.querySelector(".remove-day-btn");
  if (removeBtn) {
    removeBtn.addEventListener("click", () => {
      dayBlock.remove();
      updateWorkoutJSON();
    });
  }

  dayBlock.querySelector(".day-name")
    .addEventListener("input", updateWorkoutJSON);

  // prefill any exercises
  exercises.forEach(ex => addExercise(dayBlock, ex));

  daysContainer.appendChild(dayBlock);
  updateWorkoutJSON();
  return dayBlock;
}

addDayBtn.addEventListener("click", () => addDay());


  // Editing prefill: only if there is existing structure
  if (workoutDataTag && workoutDataTag.textContent.trim()) {
    const existingWorkout = JSON.parse(workoutDataTag.textContent);
    if (existingWorkout.length) {
      // Assume client is already set; hide hint, allow adding/removing days
      daysHint.classList.add("hidden");
      addDayBtn.disabled = false;
      addDayBtn.classList.remove("opacity-50", "cursor-not-allowed");
      existingWorkout.forEach(day => addDay(day.day, day.exercises));
    }
  }

  async function fetchClientDays(clientId) {
    const res = await fetch(`/api/schedule/client-days/${clientId}/`);
    if (!res.ok) return [];
    const data = await res.json();
    return data.days || [];
  }

  async function saveClientDays(clientId, days) {
    const res = await fetch(`/api/schedule/client-days/${clientId}/`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ days })
    });
    return res.ok;
  }

  function getSelectedPrefDays() {
    return Array.from(document.querySelectorAll(".pref-day-checkbox:checked"))
      .map(cb => cb.value);
  }

  function showPreferredDaysPanel(show) {
    prefPanel.classList.toggle("hidden", !show);
  }

  function setBuilderLockedWith(days) {
    daysContainer.innerHTML = "";
    workoutInput.value = "";
    days.forEach(d => addDay(d, [], true)); // locked day names
    daysHint.classList.add("hidden");
    addDayBtn.disabled = true;
    addDayBtn.classList.add("opacity-50", "cursor-not-allowed");
  }

  clientSelect.addEventListener("change", async () => {
    const clientId = clientSelect.value;
    // Show hint until a real client is chosen
    if (!clientId) {
      daysHint.classList.remove("hidden");
      prefPanel.classList.add("hidden");
      addDayBtn.disabled = true;
      addDayBtn.classList.add("opacity-50", "cursor-not-allowed");
      daysContainer.innerHTML = "";
      workoutInput.value = "";
      return;
    }

    // Client selected: hide hint and check server for preferred days
    daysHint.classList.add("hidden");
    const days = await fetchClientDays(clientId);

    if (days.length > 0) {
      showPreferredDaysPanel(false);
      setBuilderLockedWith(days);
    } else {
      // No preferences: show structured multiselect; keep builder blank until saved
      showPreferredDaysPanel(true);
      daysContainer.innerHTML = "";
      workoutInput.value = "";
      addDayBtn.disabled = true;
      addDayBtn.classList.add("opacity-50", "cursor-not-allowed");
    }
  });

savePrefBtn.addEventListener("click", async () => {
  const clientId = clientSelect.value;
  if (!clientId) return;

  const chosen = getSelectedPrefDays();
  prefFeedback.textContent = "";
  if (!chosen.length) {
    prefFeedback.textContent = "Please select at least one day.";
    return;
  }

  // Grab CSRF token from hidden input
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  // Save preferred days with CSRF
  const res = await fetch(`/api/schedule/client-days/${clientId}/`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": csrfToken
    },
    body: JSON.stringify({ days: chosen })
  });

  if (res.ok) {
    showPreferredDaysPanel(false);
    setBuilderLockedWith(chosen);
    prefFeedback.textContent = "";
  } else {
    prefFeedback.textContent = "Could not save days. Please try again.";
  }
});




  // AI Workout Plan generator
  document.getElementById("generate-ai-btn").addEventListener("click", async () => {
    const form = document.querySelector("form");
    const data = {
      difficulty: form.querySelector('select[name="difficulty"]').value,
      duration_weeks: form.querySelector('input[name="duration_weeks"]').value,
      goal: form.querySelector('select[name="goal"]').value,
      days_per_week: form.querySelector('input[name="days_per_week"]').value,
      include_warmup_cooldown: form.querySelector('input[name="include_warmup_cooldown"]').checked
    };

    const res = await fetch("/generate-ai-workout/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });
    const result = await res.json();
    if (result.workout_structure) {
      document.getElementById("id_workout_structure").value = JSON.stringify(result.workout_structure);

      const preview = document.getElementById("ai-preview");
      preview.innerHTML = "";
      Object.entries(result.workout_structure).forEach(([day, exercises]) => {
        const dayDiv = document.createElement("div");
        dayDiv.innerHTML = `<h3 class="font-bold">${day}</h3>`;
        const ul = document.createElement("ul");
        exercises.forEach(ex => {
          ul.innerHTML += `<li>${ex.name} â€“ ${ex.sets}Ã—${ex.reps}</li>`;
        });
        dayDiv.appendChild(ul);
        preview.appendChild(dayDiv);
      });
    }
  });
})
</script>

<script>
(function(){
  const API = "api/schedule/exercises/search"; // update to match your URL name if different
  const DEBOUNCE_MS = 220;
  const RESULT_LIMIT = 10;

  // utils
  function debounce(fn, wait) {
    let t;
    return function(...args) {
      clearTimeout(t);
      t = setTimeout(() => fn.apply(this, args), wait);
    };
  }
  function createEl(html) {
    const div = document.createElement('div');
    div.innerHTML = html;
    return div.firstElementChild;
  }

  // Render a result row
  function renderRow(item) {
    // sanitize minimal
    const name = item.name || '';
    const muscles = item.muscle_groups ? (` Â· ${item.muscle_groups}`) : '';
    const meta = [item.category, item.equipment, item.difficulty].filter(Boolean).join(' Â· ');
    return `
      <button type="button" class="suggest-row w-full text-left px-3 py-2 hover:bg-primary-50 focus:bg-primary-50 flex items-start gap-3">
        <div class="flex-1 min-w-0">
          <div class="font-medium text-sm truncate">${escapeHtml(name)}</div>
          <div class="text-xs text-gray-500 truncate">${escapeHtml(meta)}${escapeHtml(muscles)}</div>
        </div>
        ${ item.demo ? '<i class="fas fa-play-circle text-sm text-primary-400"></i>' : '' }
      </button>
    `;
  }

  function escapeHtml(s='') {
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // attach autocomplete behavior to a single input element
  function attachAutocomplete(input) {
    if (input._autocompleteAttached) return; // idempotent
    input._autocompleteAttached = true;

    // ensure parent container is positioned
    const container = input.parentElement;
    container.style.position = container.style.position || 'relative';

    const dropdown = container.querySelector('.autocomplete-dropdown');
    if (!dropdown) {
      const dd = document.createElement('div');
      dd.className = 'autocomplete-dropdown hidden absolute z-50 mt-1 w-full bg-white shadow-md rounded';
      container.appendChild(dd);
    }

    const dd = container.querySelector('.autocomplete-dropdown');
    const hiddenId = container.querySelector('.exercise-id');

    let items = [];
    let highlighted = -1;

    const doSearch = debounce(async () => {
      const q = input.value.trim();
      if (!q) { dd.classList.add('hidden'); dd.innerHTML = ''; return; }

      try {
        const url = new URL(API, window.location.origin);
        url.searchParams.set('q', q);
        url.searchParams.set('limit', RESULT_LIMIT);

        const res = await fetch(url.toString(), {
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        if (!res.ok) throw new Error('network');
        const data = await res.json();
        items = (data.results || []);
        if (!items.length) {
          dd.innerHTML = `<div class="px-3 py-2 text-sm text-gray-500">No matches</div>`;
          dd.classList.remove('hidden');
          highlighted = -1;
          return;
        }
        dd.innerHTML = items.map(renderRow).join('');
        dd.classList.remove('hidden');
        highlighted = -1;
      } catch(err) {
        dd.innerHTML = `<div class="px-3 py-2 text-sm text-red-500">Error</div>`;
        dd.classList.remove('hidden');
        console.error(err);
      }
    }, DEBOUNCE_MS);

    // keyboard navigation
    function highlightRow(idx) {
      const rows = dd.querySelectorAll('.suggest-row');
      rows.forEach((r,i)=> r.classList.toggle('bg-primary-50', i===idx));
      highlighted = idx;
      if (idx >=0 && rows[idx]) rows[idx].scrollIntoView({ block: 'nearest' });
    }

    // click selection handler (delegated)
    dd.addEventListener('click', (ev) => {
      const row = ev.target.closest('.suggest-row');
      if (!row) return;
      const rows = Array.from(dd.querySelectorAll('.suggest-row'));
      const idx = rows.indexOf(row);
      selectItem(idx);
    });

    function selectItem(idx) {
      if (idx < 0 || idx >= items.length) return;
      const it = items[idx];
      input.value = it.name;
      if (hiddenId) hiddenId.value = it.id;
      dd.classList.add('hidden');
      dd.innerHTML = '';
      // optionally trigger updateWorkoutJSON if you depend on it
      if (window.__workoutBuilder && typeof window.__workoutBuilder.updateWorkoutJSON === 'function') {
        window.__workoutBuilder.updateWorkoutJSON();
      }
    }

    // handle keydown on input
    input.addEventListener('keydown', (e) => {
      if (dd.classList.contains('hidden')) {
        if (e.key === 'ArrowDown') { doSearch(); e.preventDefault(); } // open results
        return;
      }
      const rows = dd.querySelectorAll('.suggest-row');
      if (e.key === 'ArrowDown') { // next
        e.preventDefault();
        highlightRow(Math.min(highlighted + 1, rows.length - 1));
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        highlightRow(Math.max(highlighted - 1, 0));
      } else if (e.key === 'Enter') {
        if (highlighted >= 0) { e.preventDefault(); selectItem(highlighted); }
      } else if (e.key === 'Escape') {
        dd.classList.add('hidden');
        highlighted = -1;
      }
    });

    // blur/click outside close: keep small delay so click on row works
    document.addEventListener('click', (ev) => {
      if (!container.contains(ev.target)) {
        dd.classList.add('hidden');
      }
    });

    // trigger search on input
    input.addEventListener('input', () => {
      // clear selected id if user typed after selection
      if (hiddenId) hiddenId.value = '';
      doSearch();
    });

    // also search when focusing (to show suggestions quickly)
    input.addEventListener('focus', () => {
      if (input.value.trim()) doSearch();
    });
  }

  // Delegate attachment: handle dynamically added inputs
  document.addEventListener('focusin', (ev) => {
    const el = ev.target;
    if (el.matches && el.matches('.exercise-name')) {
      attachAutocomplete(el);
    }
  });

  // Attach to any existing inputs on page load
  document.querySelectorAll('.exercise-name').forEach(attachAutocomplete);

})();
</script>

{% endblock %}
