{% extends "base.html" %}
{% block title %}{{ workout_plan.title }} Â· {{ branding.brand_name }}{% endblock %}

{% block content %}
<!-- Root -->
<div class="min-h-screen bg-gradient-to-br from-primary-50/70 via-white to-primary-100/80">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 space-y-8">

    <!-- Header + Actions -->
    <header class="rounded-3xl bg-white/60 backdrop-blur-xl shadow-2xl ring-1 ring-black/5 p-6 sm:p-8 flex flex-col gap-6 sm:flex-row sm:items-center sm:justify-between">
      <div class="space-y-1">
        <h1 class="text-2xl sm:text-4xl font-extrabold tracking-tight text-primary-600 flex items-center gap-3">
          <i class="fas fa-dumbbell text-primary-400"></i>
          {{ workout_plan.title }}
        </h1>
        <p class="text-gray-600 text-sm sm:text-base">
          Cinematic, guided training. Clear structure. Real progressâ€”every session.
        </p>
      </div>

      <div class="flex flex-wrap items-center gap-2 sm:gap-3">
        <a href="{% url 'clients:workout_plan' %}" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-white/80 text-gray-700 shadow hover:shadow-md hover:bg-white transition focus:outline-none focus:ring-2 focus:ring-primary-400">
          <i class="fas fa-arrow-left"></i>
          Back
        </a>
        <button
          type="button"
          onclick="startWorkoutFlow()"
          class="inline-flex items-center gap-2 px-5 py-2.5 rounded-xl text-white bg-gradient-to-r from-primary-500 to-primary-700 shadow-lg hover:shadow-xl hover:scale-[1.02] transition transform focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-400"
          aria-label="Start guided workout">
          <i class="fas fa-play animate-pulse"></i>
          Start Guided
        </button>
      </div>
    </header>

    <!-- Plan summary -->
    <section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
      <div class="flex items-center gap-3 rounded-2xl bg-white/70 backdrop-blur-lg shadow p-4">
        <div class="h-10 w-10 rounded-xl bg-primary-100 text-primary-600 grid place-items-center">
          <i class="fas fa-user-tie"></i>
        </div>
        <div>
          <p class="text-xs uppercase tracking-wide text-gray-500">Trainer</p>
          <p class="font-semibold text-gray-800">{{ workout_plan.trainer.user.get_full_name }}</p>
        </div>
      </div>

      <div class="flex items-center gap-3 rounded-2xl bg-white/70 backdrop-blur-lg shadow p-4">
        <div class="h-10 w-10 rounded-xl bg-amber-100 text-amber-600 grid place-items-center">
          <i class="fas fa-bolt"></i>
        </div>
        <div>
          <p class="text-xs uppercase tracking-wide text-gray-500">Intensity</p>
          <p class="font-semibold text-gray-800">{{ workout_plan.get_difficulty_display }}</p>
        </div>
      </div>

      <div class="flex items-center gap-3 rounded-2xl bg-white/70 backdrop-blur-lg shadow p-4">
        {% if workout_plan.is_active %}
          <div class="h-10 w-10 rounded-xl bg-emerald-100 text-emerald-600 grid place-items-center">
            <i class="fas fa-check-circle"></i>
          </div>
          <div>
            <p class="text-xs uppercase tracking-wide text-gray-500">Status</p>
            <p class="font-semibold text-emerald-600">Active</p>
          </div>
        {% else %}
          <div class="h-10 w-10 rounded-xl bg-gray-200 text-gray-600 grid place-items-center">
            <i class="fas fa-pause-circle"></i>
          </div>
          <div>
            <p class="text-xs uppercase tracking-wide text-gray-500">Status</p>
            <p class="font-semibold text-gray-700">Inactive</p>
          </div>
        {% endif %}
      </div>

      <div class="flex items-center gap-3 rounded-2xl bg-white/70 backdrop-blur-lg shadow p-4">
        <div class="h-10 w-10 rounded-xl bg-rose-100 text-rose-600 grid place-items-center">
          <i class="fas fa-fire"></i>
        </div>
        <div>
          <p class="text-xs uppercase tracking-wide text-gray-500">Streak</p>
          <p class="font-semibold text-gray-800"><span id="streak-count">0</span> days</p>
        </div>
      </div>
    </section>

    <!-- Week schedule -->
    <section class="space-y-4">
      {% for block in workout_structure %}
      <article id="day-{{ block.day }}" class="rounded-3xl bg-white/60 backdrop-blur-lg shadow-xl ring-1 ring-black/5 p-6 transition will-change-transform hover:scale-[1.01]">
        <!-- Day header -->
        <button
          type="button"
          class="w-full flex items-center justify-between gap-4 px-4 py-3 rounded-xl bg-white/50 hover:bg-white transition focus:outline-none focus:ring-2 focus:ring-primary-400"
          onclick="toggleDayPanel(this)"
          aria-expanded="{% if current_day == block.day %}true{% else %}false{% endif %}"
          aria-controls="panel-{{ block.day }}">
          <div class="flex items-center gap-3">
            <div class="h-9 w-9 rounded-lg bg-primary-100 text-primary-600 grid place-items-center">
              <i class="fas fa-calendar-day"></i>
            </div>
            <h2 class="text-lg sm:text-xl font-bold text-gray-800">Day {{ block.day }}</h2>
          </div>

          <div class="flex items-center gap-4">
            <div class="hidden sm:block w-28 h-2 bg-gray-200 rounded-full overflow-hidden">
              <div id="progress-{{ block.day }}" class="h-full bg-primary-500 transition-all duration-500" style="width: 0%;"></div>
            </div>
            <i class="fas fa-chevron-right text-gray-500 transition-transform duration-300 {% if current_day == block.day %}rotate-90{% endif %}"></i>
          </div>
        </button>

        <!-- Exercise grid -->
        <div id="panel-{{ block.day }}" class="mt-4 {% if current_day != block.day %}hidden{% endif %}" role="region" aria-labelledby="day-{{ block.day }}">
          {% if block.exercises %}
          <ul class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for ex in block.exercises %}
            <li
              class="relative group rounded-2xl bg-white/80 backdrop-blur-md shadow p-4 hover:shadow-lg transition"
              data-exercise-card
              data-day="{{ block.day }}"
              data-name="{{ ex.name }}"
              data-sets="{{ ex.sets }}"
              data-reps="{{ ex.reps }}"
              data-video="{{ ex.video_url|default:'' }}"
              {% if ex.done %}data-done="true"{% endif %}>

              <!-- Card header -->
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                  <span class="inline-grid h-8 w-8 place-items-center rounded-lg bg-primary-50 text-primary-600">
                    <i class="fas fa-dumbbell"></i>
                  </span>
                  <span class="font-semibold text-gray-800">{{ ex.name }}</span>
                </div>
                {% if ex.video_url %}
                <button
                  type="button"
                  onclick="openVideoModal('{{ ex.video_url }}')"
                  class="text-primary-600 hover:text-primary-700 transition focus:outline-none focus:ring-2 focus:ring-primary-300 rounded-lg px-2 py-1"
                  aria-label="Watch {{ ex.name }} demo">
                  <i class="fas fa-play-circle text-2xl"></i>
                </button>
                {% endif %}
              </div>

              <!-- Meta -->
              <div class="flex justify-between items-center text-sm text-gray-600">
                <span><strong class="text-gray-800">Sets:</strong> {{ ex.sets }}</span>
                <span><strong class="text-gray-800">Reps:</strong> {{ ex.reps }}</span>
              </div>

              <!-- Tags -->
              <div class="mt-2 flex gap-2 flex-wrap">
                {% if ex.intensity %}
                <span class="inline-flex items-center gap-1 px-2 py-1 text-xs rounded-full bg-purple-100 text-purple-800">
                  <i class="fas fa-bolt"></i> Effort: {{ ex.intensity }}
                </span>
                {% endif %}
                {% if ex.calories %}
                <span class="inline-flex items-center gap-1 px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">
                  <i class="fas fa-fire"></i> {{ ex.calories }} kcal
                </span>
                {% endif %}
              </div>

              <!-- Actions -->
              <div class="mt-3 flex items-center justify-between">
                <button
                  type="button"
                  onclick="queueSingleExercise(this)"
                  class="text-sm text-primary-600 hover:text-primary-800 transition focus:outline-none focus:ring-2 focus:ring-primary-300 rounded-lg px-2 py-1"
                  aria-label="Queue {{ ex.name }} in guided mode">
                  <i class="fas fa-list-check mr-1"></i> Queue
                </button>

                {% if ex.done %}
      <span class="absolute top-2 right-2 bg-green-600 text-white text-xs px-2 py-1 rounded-full">
        Done
      </span>
    {% endif %}

    <!-- Mark as Done button -->
    {% if not ex.done %}
      <button
        type="button"
        onclick="markExerciseDoneFromCard(this)"
        data-action="complete"
        class="mt-3 text-sm font-medium text-emerald-600 hover:text-emerald-800 transition"
      >
        <i class="fas fa-check-circle mr-1"></i> Mark as Done
      </button>
    {% endif %}
              </div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
            <p class="text-gray-500 italic mt-2">No exercises added for this day.</p>
          {% endif %}
        </div>
      </article>
      {% endfor %}
    </section>

    <!-- Global CTA -->
    <div class="sticky bottom-6">
      <button
        type="button"
        onclick="startWorkoutFlow()"
        class="w-full rounded-2xl bg-gradient-to-r from-primary-500 to-primary-700 text-white py-3 text-lg font-semibold shadow-xl hover:shadow-2xl hover:scale-[1.01] transition transform focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-400">
        <i class="fas fa-play mr-2"></i> Start Workout
      </button>
    </div>

  </div>
</div>

<!-- Video Modal -->
<div id="videoModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm grid place-items-center z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="videoModalTitle">
  <div class="bg-white rounded-xl overflow-hidden shadow-2xl w-full max-w-2xl ring-1 ring-black/10" data-modal-surface>
    <div class="flex items-center justify-between px-4 py-3 bg-primary-600 text-white">
      <h3 id="videoModalTitle" class="text-lg font-semibold">Exercise Demo</h3>
      <button type="button" onclick="closeVideoModal()" class="rounded-lg px-2 py-1 hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-white" aria-label="Close video modal">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="aspect-video bg-black">
      <iframe id="videoFrame" class="w-full h-full" src="" frameborder="0" allowfullscreen title="Exercise demo video"></iframe>
    </div>
  </div>
</div>

<!-- Guided Overlay -->
<div id="workoutOverlay" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden grid place-items-center p-4" role="dialog" aria-modal="true" aria-labelledby="overlayTitle">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6 sm:p-7 ring-1 ring-black/10 relative" data-modal-surface>
    <button type="button" onclick="closeWorkoutOverlay()" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 rounded-lg px-2 py-1 focus:outline-none focus:ring-2 focus:ring-gray-300" aria-label="Close guided workout">
      <i class="fas fa-times"></i>
    </button>

    <h2 id="overlayTitle" class="text-xl sm:text-2xl font-extrabold text-primary-600"></h2>
    <p id="progressTracker" class="text-sm text-gray-500 mt-1">
      Exercise <span id="progressCurrent">1</span> of <span id="progressTotal">0</span>
    </p>

    <div class="mt-4 rounded-xl overflow-hidden ring-1 ring-black/10">
      <iframe id="exerciseVideo" class="w-full aspect-video" src="" frameborder="0" allowfullscreen title="Guided exercise video"></iframe>
    </div>

    <p id="exerciseDetails" class="text-sm text-gray-700 mt-3"></p>
    <p id="motivationalQuote" class="text-sm italic text-primary-600 mt-1"></p>

    <div class="mt-5 flex flex-wrap items-center justify-center gap-3">
      <button type="button" onclick="markCurrentExerciseDone()" class="rounded-full bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2 shadow focus:outline-none focus:ring-2 focus:ring-emerald-300">
        <i class="fas fa-check-circle mr-1"></i> Mark as Done
      </button>
      <button type="button" onclick="nextExercise()" class="rounded-full bg-white text-primary-700 hover:bg-gray-50 px-5 py-2 shadow focus:outline-none focus:ring-2 focus:ring-primary-300">
        Next â†’
      </button>
    </div>
  </div>
</div>


<script>
  const CLIENT_ID = "{{ workout_plan.client.id }}";
  const PLAN_ID = "{{ workout_plan.id }}";
  const CURRENT_DAY = "{{ current_day }}";
  const FITNESS_LEVEL = "{{ workout_plan.difficulty }}";
</script>

<!-- Interactions -->
<script>
  // Reduced motion support
  const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  function toggleDayPanel(btn) {
    const icon = btn.querySelector('.fa-chevron-right');
    const container = btn.closest('article');
    const panel = container.querySelector('[id^="panel-"]');
    const expanded = btn.getAttribute('aria-expanded') === 'true';
    btn.setAttribute('aria-expanded', !expanded);
    panel.classList.toggle('hidden');
    icon.classList.toggle('rotate-90');
  }

  // Video modal
  function openVideoModal(url) {
    const modal = document.getElementById('videoModal');
    const frame = document.getElementById('videoFrame');
    frame.src = url;
    modal.classList.remove('hidden');
    trapFocus(modal);
  }
  function closeVideoModal() {
    const modal = document.getElementById('videoModal');
    const frame = document.getElementById('videoFrame');
    frame.src = '';
    modal.classList.add('hidden');
    releaseFocus();
  }

  // Guided flow state
  let workoutQueue = [];
  let currentIndex = 0;

  function allExerciseCards() {
    return Array.from(document.querySelectorAll('li[data-exercise-card]'));
  }

  function collectExercisesForToday() {
    // Collect only exercises in expanded panels (current visible day)
    const openPanels = Array.from(document.querySelectorAll('[id^="panel-"]:not(.hidden)'));
    const cards = openPanels.flatMap(p => Array.from(p.querySelectorAll('li[data-exercise-card]')));
    const chosen = cards.length ? cards : allExerciseCards(); // fallback: all
    return chosen.map(el => ({
      el,
      day: el.dataset.day,
      name: el.dataset.name,
      sets: el.dataset.sets,
      reps: el.dataset.reps,
      video: el.dataset.video || ''
    }));
  }

  function queueSingleExercise(btn) {
    const card = btn.closest('[data-exercise-card]');
    workoutQueue = [{
      el: card,
      day: card.dataset.day,
      name: card.dataset.name,
      sets: card.dataset.sets,
      reps: card.dataset.reps,
      video: card.dataset.video || ''
    }];
    currentIndex = 0;
    showExercise(workoutQueue[currentIndex]);
    const overlay = document.getElementById('workoutOverlay');
    overlay.classList.remove('hidden');
    trapFocus(overlay);
    fetchMotivation(FITNESS_LEVEL);
  }

  function startWorkoutFlow() {
    workoutQueue = collectExercisesForToday();
    if (!workoutQueue.length) {
      alert('No exercises available.');
      return;
    }
    currentIndex = 0;
    showExercise(workoutQueue[currentIndex]);
    const overlay = document.getElementById('workoutOverlay');
    overlay.classList.remove('hidden');
    trapFocus(overlay);
    fetchMotivation(FITNESS_LEVEL);
  }

  function showExercise(ex) {
    document.getElementById('overlayTitle').textContent = ex.name;
    document.getElementById('exerciseDetails').textContent = `Sets: ${ex.sets} Â· Reps: ${ex.reps}`;
    document.getElementById('exerciseVideo').src = ex.video;
    document.getElementById('progressCurrent').textContent = currentIndex + 1;
    document.getElementById('progressTotal').textContent = workoutQueue.length;
  }

  function closeWorkoutOverlay() {
    const overlay = document.getElementById('workoutOverlay');
    const frame = document.getElementById('exerciseVideo');
    frame.src = '';
    overlay.classList.add('hidden');
    releaseFocus();
  }

  async function markCurrentExerciseDone() {
    const ex = workoutQueue[currentIndex];
    try {
      await markExerciseCompleteAPI(ex.name, ex.day);
      markCardAsDone(ex.el);
      updateDayProgress(ex.day);
      nextExercise();
    } catch (e) {
      alert('Could not save progress. Try again.');
    }
  }

  function nextExercise() {
    currentIndex++;
    if (currentIndex < workoutQueue.length) {
      showExercise(workoutQueue[currentIndex]);
    } else {
      closeWorkoutOverlay();
      setTimeout(() => alert('Workout complete! ðŸ’ª'), 50);
    }
  }

  // Completion API + UI
  async function markExerciseCompleteAPI(exerciseName, day) {
    const res = await fetch("{% url 'dashboard_api:complete' %}", {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
      body: JSON.stringify({ client_id: CLIENT_ID, plan_id: PLAN_ID, day: day || CURRENT_DAY, exercise_name: exerciseName })
    });
    if (!res.ok) throw new Error('Save failed');
    const data = await res.json();
    if (data?.streak != null) {
      const el = document.getElementById('streak-count');
      if (el) el.textContent = data.streak;
    }
    return data;
  }

  async function markExerciseDoneFromCard(buttonEl) {
    const card = buttonEl.closest('[data-exercise-card]');
    const name = card?.dataset.name;
    const day = card?.dataset.day || CURRENT_DAY;
    try {
      await markExerciseCompleteAPI(name, day);
      markCardAsDone(card);
      updateDayProgress(day);
    } catch (e) {
      alert('Could not save progress.');
    }
  }

  function markCardAsDone(cardEl) {
    cardEl.setAttribute('data-done', 'true');
    const btn = cardEl.querySelector('[data-action="complete"]');
    if (btn) {
      btn.textContent = "âœ… Completed";
      btn.disabled = true;
      btn.classList.add("text-gray-400", "cursor-not-allowed");
    }
    if (!cardEl.querySelector('.badge-done')) {
      const badge = document.createElement('span');
      badge.className = 'badge-done absolute top-2 right-2 bg-emerald-600 text-white text-xs px-2 py-1 rounded-full shadow';
      badge.textContent = 'Done';
      cardEl.appendChild(badge);
    }
  }

  function updateDayProgress(dayName) {
    const dayRoot = document.getElementById(`day-${dayName}`);
    if (!dayRoot) return;
    const cards = dayRoot.querySelectorAll('[data-exercise-card]');
    const total = cards.length;
    const done = Array.from(cards).filter(c => c.getAttribute('data-done') === 'true').length;
    const pct = total ? Math.round((done / total) * 100) : 0;
    const bar = document.getElementById(`progress-${dayName}`);
    if (bar) bar.style.width = pct + '%';
  }

  // Motivation
  async function fetchMotivation(level) {
    try {
      const url = new URL("{% url 'dashboard_api:motivation' %}", window.location.origin);
      url.searchParams.set("level", level);
      const res = await fetch(url.toString(), { headers: { "X-Requested-With": "XMLHttpRequest" } });
      if (res.ok) {
        const data = await res.json();
        const q = document.getElementById('motivationalQuote');
        if (q) q.textContent = data.message;
      }
    } catch (_) {}
  }

  // Focus trap for modals (accessibility)
  let previousFocus = null;
  function trapFocus(container) {
    previousFocus = document.activeElement;
    const focusables = container.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    const first = focusables[0];
    const last = focusables[focusables.length - 1];
    function loop(e) {
      if (e.key !== 'Tab') return;
      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault(); last.focus();
      } else if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault(); first.focus();
      }
    }
    container.addEventListener('keydown', loop);
    container.dataset.trap = '1';
    setTimeout(() => first?.focus(), 10);
  }
  function releaseFocus() {
    const trapped = document.querySelector('[data-trap="1"]');
    if (trapped) trapped.removeAttribute('data-trap');
    previousFocus?.focus?.();
  }

  // Close on ESC/backdrop click
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeVideoModal();
      closeWorkoutOverlay();
    }
  });
  document.getElementById('videoModal').addEventListener('click', (e) => {
    if (e.target.id === 'videoModal') closeVideoModal();
  });
  document.getElementById('workoutOverlay').addEventListener('click', (e) => {
    if (e.target.id === 'workoutOverlay') closeWorkoutOverlay();
  });

  // Initialize: scroll to current day, compute progress bars
  document.addEventListener('DOMContentLoaded', function() {
    const el = document.getElementById("day-{{ current_day }}");
    if (el && !prefersReducedMotion) {
      el.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    document.querySelectorAll('[id^="day-"]').forEach(dayEl => {
      const dayName = dayEl.id.replace('day-', '');
      updateDayProgress(dayName);
    });
  });
</script>
{% endblock %}
